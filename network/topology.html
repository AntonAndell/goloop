<html>
<head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/simple-jsonrpc-js@0.0.10/dist/simple-jsonrpc-js.min.js"></script>

    <style type="text/css">
        #selfNetwork {
            width: 800px;
            height: 400px;
            border: 1px solid lightgray;
        }
        #selfDesc {
            width: 400px;
            height: 400px;
        }
    </style>
</head>
<body>
<table>
    <tr>
        <td><div id="selfNetwork"></div></td>
        <td><pre><code id="selfDesc">Click node</code></pre></td>
    </tr>
</table>

<script type="text/javascript">
    var _color = {
        node: {
            0: '#99CCFF',
            1: '#99FF99',
            2: '#9999FF',
            3: '#CC99FF'
        },
        edge: {
            0: {color: 'black', highlight: 'black'},
            1: {color: 'blue', highlight: 'blue'},//parent
            2: {color: 'blue', highlight: 'blue'},//children
            3: {color: 'red', highlight: 'red'},//uncle
            4: {color: 'red', highlight: 'red'},//nephew
            5: {color: 'violet', highlight: 'violet'},//friend
        }
    }

    function addNode(self, p){
        if (p && Object.keys(p).length !== 0) {
            data = _data()
            if (data.peers[p.id] === undefined) {
                data.nodes.add({id: p.id, label: _label(p), level: _level(p.role), color: _color.node[p.role]})
                p.label=_label(p)
                data.peers[p.id] = p
            }
            if (p.in) {
                data.edges.add({from: p.id, to: self.id, color: _color.edge[p.conn]})
            } else {
                data.edges.add({from: self.id, to: p.id, color: _color.edge[p.conn]})
            }  
        }
    }
    var url = "http://127.0.0.1:9080"
    var data = {
        nodes: new vis.DataSet(),
        edges: new vis.DataSet(),
        peers: {}
    };
    var container = document.getElementById('selfNetwork');
    var options = {
        height: '100%',
        width: '100%',
        nodes: {
            shape: 'dot',
            scaling: {
                min: 1,
                max: 5
            }
        },
        edges:{
            arrows: 'to',
            smooth: {
                type: 'continuous',
                roundness: 1
            }
        },
        layout: {
            hierarchical: {
                enabled: true,
                direction: 'UD'
            }
        }
    };
    function _data(){
        return data
    }
    function _label(p){
        label = ""
        r = p.role+0
        if (r == 0) {
            label += "C"
        } else if (r == 1) {
            label += "S"
        } else if (r == 2) {
            label += "R"
        } else if (r == 3) {
            label += "RS"
        }
        label += "_"+p.id.substring(0,10)
        return label
    }
    function _level(r){
        if (r+0 == 3) {
            return 1
        } else {
            return 2-(r+0)
        }
    }
    var network = new vis.Network(container, data, options);
   
    drawNetwork("", data.nodes, data.edges, data.peers)
   
    network.on("click", function(params){
        data = _data()
        p = data.peers[params.nodes[0]]
        document.getElementById('selfDesc').innerHTML = JSON.stringify(p, undefined,4)
    })
    function drawNetwork(url){
        var jrpc = new simple_jsonrpc();
        jrpc.toStream = function(_msg){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState != 4) return;
                try {
                    JSON.parse(this.responseText);
                    jrpc.messageHandler(this.responseText);
                }
                catch (e){
                    console.error(e);
                }
            };
            xhr.open("POST", url+'/network', true);
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            //xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
            //xhr.setRequestHeader("Access-Control-Allow-Headers", "Content-Type,access-control-allow-origin, access-control-allow-headers");
            xhr.send(_msg);
        };
        jrpc.call('p2p',{channel:'default'}).then(function(result){
            data = _data()
            self = data.peers[result.self.id]
            if (self === undefined) {
                self = result.self
                data.peers[result.self.id]=self
                data.nodes.add({id: self.id, label: _label(self),level:_level(self.role), color: _color.node[self.role]})
            }
            self["rpc"]=true
            result.friends.forEach(function(v, i) {
                addNode(self, v)
            });
            addNode(self, result.parent)
            result.children.forEach(function(v, i) {
                addNode(self, v)
            });
            result.uncles.forEach(function(v, i) {
                addNode(self, v)
            });
            result.nephews.forEach(function(v, i) {
                addNode(self, v)
            });

            result.friends.forEach(function(v, i) {
                addr = "http://" + v.addr.replace(":80", ":90");
                if (data.peers[v.id]["rpc"] === undefined) {
                    console.log(i + "f_" +self.addr+" "+v.addr)
                    drawNetwork(addr)
                }
            });
            result.children.forEach(function(v, i) {
                addr = "http://" + v.addr.replace(":80", ":90");
                if (data.peers[v.id]["rpc"] === undefined) {
                    console.log(i + "c_" +self.addr+" "+v.addr)
                    drawNetwork(addr)
                }
            });
        });
    }    
</script>
</body>
</html>